---
title: "Exploratory Analysis"
author: "David John Baker"
date: "20/10/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This document documents two exploratory analyses we consider for the manuscript.
The first explores an unsupervised clustering approach to the features of the chords.
The second uses PCA to reduce the attraction ratings to a single component
Each is discussed in turn.

* PCA: Let Individuals Construct Attraction Space
* HAC: Let Features Construct

## Data Import 

```{r}
library(readr)
library(stringr)
library(ggplot2)
library(magrittr)
library(tidyr)
library(forcats)
library(janitor)
library(psych)
library(tidymodels)
library(dplyr)


# Importing Data
## Experimental Data 
response_data <- read_csv("tidy_tables/response_data.csv")


# Get only rating data
attraction_ratings <- response_data %>%
  dplyr::select(I:`viio7/V`, group, participant)

# Demographic Data
gmsi <- read_csv("tidy_tables/gmsi_table.csv")
gmsi <- janitor::clean_names(gmsi)
gmsi <- gmsi %>% 
  rename(experimental_group = group,
         participant = participant_no)

gmsi %>%
  dplyr::select(participant, i_have_had_formal_training_in_music_theory_for_years) -> gmsi_2

attraction_ratings <- attraction_ratings %>% 
  left_join(gmsi_2)
  


chord_stimuli_data <- read_csv("tidy_tables/chord_experiment_stimuli_data.csv")

chord_stimuli_data <- chord_stimuli_data %>% 
  rename(chord = chord_symbol,
         chord_family = group) 
```

The object `attraction_ratings` now has all the ratings of the chords and the group identifier from where the rating came from. 

Next, we prep and run the PCA on this data.
Experimental group is saved to be an identifier.



```{r}
# Make Exploratory Plot 
pca_rec <- recipe(~., data = attraction_ratings ) %>%
    update_role(group, participant, i_have_had_formal_training_in_music_theory_for_years, new_role = "id") %>%
  step_normalize(all_predictors()) %>%
  step_pca(all_predictors())

pca_prep <- prep(pca_rec)

pca_prep

tidied_pca <- tidy(pca_prep, 2)

chord_stimuli_data_table <- chord_stimuli_data %>%
  rename(terms = chord)

tidied_pca %>%
  left_join(chord_stimuli_data_table) -> tidied_pca2



```

Now we have scores for every single chord on every single dimension. 

Let's explore.

Want to know if our PCA was helpful at all first. 

* First PC explains ~25% of variation (not bad)
* Next two are also formidable
* I expected this to be like all on one, nothing left over
* Warrents looking at at least 4 after the first one

```{r}
sdev <- pca_prep$steps[[2]]$res$sdev

percent_variation <- sdev^2 / sum(sdev^2)

sum(percent_variation[1:3])
sum(percent_variation[1])
sum(percent_variation[2])
sum(percent_variation[3])



tibble(
  component = unique(tidied_pca$component),
  percent_var = percent_variation ## use cumsum() to find cumulative, if you prefer
) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(component, percent_var)) +
  geom_col() +
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = NULL, y = "Percent Variance",
       title = "Cumulative Variance Explained") +
  theme_minimal() +
  coord_flip() -> var_explained_plot

var_explained_plot

ggsave(filename = "img/Figures/Figure_Variation_Explained.png", 
       height = 6, width = 9, dpi = 300, plot = var_explained_plot)




```


Next we plot the first five principle components with all items.

Main take aways from plot

* PC1 appears to be just general attraction rating
* All scores positive reflect the fact that all asked to do same task
* Going to look at each in depth after

```{r}
# EXCLUDE 

tidied_pca2 %>%
  filter(component %in% paste0("PC", 1:5)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(value, terms, fill = chord_family)) +
  geom_col() +
  facet_wrap(~component, nrow = 1) +
  labs(y = "Chord", x = "Loading", title = "First Five Principal Components") -> pc15

pc15

ggsave(filename = "img/Figures/Figure_PC1to5.png", height = 6, width = 9, dpi = 300, plot = pc15)

```

PC1 is "attractiveness" in general. 

```{r}

tidied_pca2 %>%
  filter(component %in% paste0("PC", 1)) %>%
  mutate(component = fct_inorder(component)) %>%
  mutate(value = round(value, 3)) %>%
  mutate(chord_family = str_replace_all(chord_family, "_"," ")) %>%
  mutate(chord_family = str_to_title(chord_family)) %>%
  mutate(chord_family = str_replace_all(chord_family,"Pd","PDs")) %>%
  ggplot(aes(x = value, y = reorder(terms, abs(value)))) +
  geom_point(aes(shape = chord_family), size = 3) +
  theme_minimal() +
  theme(legend.position="bottom") +
  labs(y = "Chord", x = "Loading",
       title = "Response Strategy: Experimental Prompt", shape = "Chord Category") -> pc1


#   scale_fill_manual(labels = c("Bridge Chords","Chromatic PDs","Common PDs","Non PDs"), values = c("green","black","blue","red")) +
pc1

ggsave(filename = "img/Figures/PC1.png", 
       height = 9, width = 5, dpi = 300, plot = pc1)

```

PC2 is expert knowledge? 

```{r}
tidied_pca2 %>%
  filter(component %in% paste0("PC", 2)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(x = value, y = reorder(terms, abs(value)), fill = chord_family)) +
  geom_col() +
  theme_minimal() +
  scale_fill_manual(labels = c("Bridge Chords","Chromatic PDs","Common PDs","Non PDs"),
                    values = c("green","black","blue","red")) +
  labs(y = "Chord", title = "PC2: Sensitivity to Training", fill = "Chord Family") -> pc2

pc2

ggsave(filename = "img/Figures/PC2.png", height = 6, width = 9, dpi = 300, plot = pc2)
```


PC3 is ? 

```{r}
tidied_pca2 %>%
  filter(component %in% paste0("PC", 3)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(x = value, y = reorder(terms, abs(value)), fill = chord_family)) +
  geom_col() +
    theme_minimal() +
  scale_fill_manual(labels = c("Bridge Chords","Chromatic PDs","Common PDs","Non PDs"),
                    values = c("green","black","blue","red")) +
  labs(y = "Chord", title = "PC3: ????", fill = "Chord Category") -> pc3

pc3

ggsave(filename = "img/Figures/PC3.png", height = 6, width = 9, dpi = 300, plot = pc3)





#--------------------------------------------------------------------------------------



tidied_pca2 %>%
  filter(component %in% paste0("PC", 31)) %>%
  mutate(component = fct_inorder(component)) %>%
  ggplot(aes(x = value, y = reorder(terms, abs(value)), fill = chord_family)) +
  geom_col(show.legend = FALSE) +
  labs(y = NULL, title = "PC31") -> pc31

pc31

```


Maybe looking at individual data will help with PC2 and PC3.

* Upperclass people score highly on negative PC1 (doing the task)
* Could put means in here to show main effect of group?
* Interesting that PC2 almost completely separates PC2
* Going back to PC2 (plot together) thoughts?

```{r}


# PANEL 2 
juice(pca_prep) %>%
  mutate(group = str_replace_all(group, "upperclass","Junior/Senior")) %>%
  mutate(group = str_to_title(group)) %>%
  mutate(`Experimental Group` = str_to_title(group)) %>%
  ggplot(aes(PC1, PC2, 
             shape = `Experimental Group`)) +
  geom_point(alpha = 1) +
  scale_shape_manual(values=c( 8, 13, 4))+
  theme_minimal() +
  theme(legend.position="bottom") +
  labs(title = "Scores of Items from PCA Loadings",
       x = "PC1: Predominant Attraction",
       y = "PC2: Sensitivity to Music Theory Training",
       shape = "Participant Group") -> pc1vpc2

pc1vpc2

ggsave(filename = "img/Figures/PC1vsPC2.png", height = 6, width = 9, dpi = 300, plot = pc1vpc2)

```



```{r}
# Make Panel
library(patchwork)

(pc1 + (pc1vpc2)) -> pca_panel


ggsave(plot = pca_panel, filename = "img/Figures/PCA_Panel.png", height = 9, width = 12, dpi = 300)

```


```{r}
juice(pca_prep) %>%
  ggplot(aes(PC1, PC3, color = group)) +
  geom_point(alpha = 0.7, size = 2) +
  labs() -> pc1vpc3

ggsave(filename = "img/unsupervised/pc1vpc3.png", height = 6, width = 9, dpi = 300, plot = pc1vpc3)

juice(pca_prep) %>%
  ggplot(aes(PC2, PC3, color = group)) +
  geom_point(alpha = 0.7, size = 2) +
  labs() -> pc2vpc3

ggsave(filename = "img/unsupervised/pc2vpc3.png", height = 6, width = 9, dpi = 300, plot = pc2vpc3)


```


```{r}
# Correlation with general average 
tidied_pca2 %>%
  filter(component == "PC1") %>%
  dplyr::select(terms, value) %>%
  rename(chord = terms) -> pca_terms


feature_model_data %>%
  dplyr::select(mean_chord_ratings, chord) %>%
  left_join(pca_terms)-> cor_pca

cor_pca %>%
  ggplot(aes(x = value, y = mean_chord_ratings, label = chord)) +
  geom_point() +
  geom_text(nudge_y = .1) +
  geom_smooth()

cor.test(cor_pca$mean_chord_ratings, cor_pca$value)


```


## Feature Analysis 

### K Means

```{r}

chord_stimuli_data <- read_csv("tidy_tables/chord_experiment_stimuli_data.csv")

chord_stimuli_data <- chord_stimuli_data %>% 
  rename(chord = chord_symbol,
         chord_family = group) 

# Chord Features
chord_features <- read_csv("tidy_tables/chord_features.csv")
chord_features <- janitor::clean_names(chord_features)

chord_features <- chord_features %>%
  separate(col = stimuli, into = c("chord_id","temp"), "\\.") %>%
  separate(col = temp, into = c("chord","notes"), sep = "\\:") %>%
  mutate(chord = str_trim(chord)) %>%
  mutate(notes = str_trim(notes))


chord_features %>%
  select(parncut_roughness:number_4_b6) -> cluster_features


rownames(cluster_features) <- chord_features$chord


cluster_features %>% scale() -> scaled_cluster_features

dist_cluster <- dist(scaled_cluster_features)


dist_cluster_object <- hclust(dist_cluster)

par(mfrow=c(1,1))


plot(dist_cluster_object ,main="", xlab="", sub="", cex=.9)



# Need to try with different linkages!!! 



dist_cluster_object_complete <- hclust(dist_cluster,method = "complete")
dist_cluster_object_average <- hclust(dist_cluster,method = "average")
dist_cluster_object_single <- hclust(dist_cluster, method = "single")

par(mfrow=c(1,3))

plot(dist_cluster_object_complete ,main="Complete Linkage", xlab="", sub="",
cex=.9)

plot(dist_cluster_object_average , main="Average Linkage", xlab="", sub="",
cex=.9)

plot(dist_cluster_object_single, main="Single Linkage", xlab="", sub="",
cex=.9)



```

DB Resources

* [Slige](https://juliasilge.com/blog/cocktail-recipes-umap/)

