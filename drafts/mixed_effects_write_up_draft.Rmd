---
title: "Mixed Effects Write Up Draft"
author: "David John Baker"
date: "20/08/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This document provides the draft of the write up for the mixed effects analysis.
It includes three analyses: 

1. Use individual to see if inclusion of musical training affects results (Q35)
2. Create musical model to see if chord families are different
3. Investigate the extent that the five features contribute to ratings

Additionally, this analysis explores Table 7 which attempts to ascertain which scale degrees were most important in determining the attraction ratings. 

The text below is written to be used in the final manuscript. 


## Data Import 

```{r, include=FALSE}
library(readr)
library(stringr)
library(ggplot2)
library(tidyr)
library(GGally)
library(MuMIn)
library(janitor)
library(dplyr)
library(lme4)
library(sjPlot)
library(lmerTest)
library(patchwork)
library(gt)

# Importing Data
## Experimental Data 
response_data <- read_csv("tidy_tables/response_data.csv")

chord_stimuli_data <- read_csv("tidy_tables/chord_experiment_stimuli_data.csv")

chord_stimuli_data <- chord_stimuli_data %>% 
  rename(chord = chord_symbol,
         chord_family = group) 

# Chord Features
chord_features <- read_csv("tidy_tables/chord_features.csv")
chord_features <- janitor::clean_names(chord_features)

chord_features <- chord_features %>%
  separate(col = stimuli, into = c("chord_id","temp"), "\\.") %>%
  separate(col = temp, into = c("chord","notes"), sep = "\\:") %>%
  mutate(chord = str_trim(chord)) %>%
  mutate(notes = str_trim(notes))

# Demographic Data
gmsi <- read_csv("tidy_tables/gmsi_table.csv")
gmsi <- janitor::clean_names(gmsi)
gmsi <- gmsi %>% 
  rename(experimental_group = group,
         participant = participant_no)

# Build Big Data 
df <- response_data %>%
  pivot_longer(cols = I:`viio7/V`,names_to = "chord",values_to = "rating") %>%
  select(participant, chord, rating, block, group, `How attracted`) %>%
  left_join(chord_stimuli_data) %>%
  left_join(gmsi) %>%
  left_join(chord_features)
```

# Results

In order to analyze the results from our experiment, we ran three separate linear mixed effects models to investigate what variation in our data was attributable to our experimental conditions, what variation was attributable to within-subject variation, and what variance was left unexplained considering our hypothesized variables of interest.
These included individual differences due to musical training, the chord family that the pre-dominant chord belonged as stated in TABLE X, and the chord's features as stated in TABLE X.

Prior to investigating the extent that chord family, musical training, and the features contributed to the model, we first ran a null model that partitioned the within-subject effects due to participant in order to establish a baseline measure we could compare further models to.
In this and all subsequent models, participant was modeled as a random effect with our dependent variable being the attraction rating.
Doing this allowed for us to account for both the violation of the independence assumption since the same participant rated each stimuli twice, once in each block.

Subsequent to our null model where participant was modeled as a random effect, we then ran our first linear mixed effects model to estimate the extent that chord family affected our attraction ratings.
Our second model added musical training to the model as a random effect.
Finally in our third model, we attempted to simultaneously consider both individual and musical features in order to examine the extent that the five features FROM THIS TABLE contributed to the attraction ratings.
In each of these three models, in addition to allowing for random intercepts for participants-- building on the null model-- we allowed random slopes for each of the fixed effects.
We chose not to run all variables simultaneously in order to prevent a singular model fit also known as over-fitting. 
Data analyses were run using the R programming language (CITE) using the `lme4` package (Bates et al).
Both data and analyses are available at <OSF LINK HERE>. 

## Null Model 

We first present the results of our null model.
Here we modelled our dependent variable of attraction using both participant and block and fully crossed random effects. 

```{r}
# Select Individual Model Data 
model_data <- df %>%
  select(rating, 
         chord_family,
         lerdhal_tension,
         parncut_roughness,
         semitone_voice_move, 
         rootmotion,
         number_tendency_tones4_6,
         participant,
         block, 
         i_have_had_formal_training_in_music_theory_for_years, 
         f3_musical_training,experimental_group) %>%
  mutate(experimental_group = factor(experimental_group, c("prolific", "freshman","upperclass")))
  
# Run Null Model 
null_model <- lmer(rating ~ (1|participant) + (1|block), data = model_data)
null_summary <- summary(null_model)
null_summary

print(paste(round(.47/(.47+1.87)*100,3),"% of the data is explained with null model"))
print("Variation due to block is negligable")
```

Running the null model, we were able to account for 20% of the variation in response due solely to variation in response of participants.
Of this 20%, a negligible amount was due to block from which we can conclude no effects of block.
This variable was not used for subsequent analyses. 

## Model 1

After the null model, we then ran a model that that listed `chord_family` as a fixed effect.
Since we theorized that there is something special about chord function/family, chord family was a fixed effect which allowed random intercepts.

```{r}
# Chord with Random Intercept 
chord_category_model <- lmer(rating ~ chord_family + (1+chord_family|participant), data = model_data)
summary(chord_category_model)
# Significantly better with chord family in model
anova(null_model, chord_category_model)

# Residuals were normally distributed
hist(resid(chord_category_model))
qqnorm(resid(chord_category_model))
qqline(resid(chord_category_model)) 

r.squaredGLMM(null_model)
r.squaredGLMM(chord_category_model)

library(sjPlot)
tab_model(chord_category_model,title = "Chord Category Model")
############################################

# Chord with Random Intercept 
musician_model <- lmer(scale(rating) ~ experimental_group  
                       + (1+i_have_had_formal_training_in_music_theory_for_years|participant), data = model_data)
summary(musician_model)
# Significantly better with chord family in model
anova(null_model, musician_model)

# Residuals were normally distributed
hist(resid(musician_model))
qqnorm(resid(musician_model))
qqline(resid(musician_model)) 

r.squaredGLMM(musician_model)
r.squaredGLMM(musician_model)



```

Results from using `chord_family` as a fixed effect resulted in a signifcantly better model fit ($\chi^2(11)=238.05$, $p<.001$).
With chord family as a fixed effect, our marginal $R^2 = .02$, with our conditional $R^2 = .28$.
Coeffecients from the model can be found in the Chord Category Model table or FIGURE X (below).

```{r}
std <- function(x) sd(x)/sqrt(length(x))

# Chord Random Slopes 
chord_category_model_random_slopes <- lmer(rating ~ chord_family + (1+ chord_family | participant), data = model_data, REML = TRUE)
(ccmrs_summary <- summary(chord_category_model_random_slopes))
(.54+.0002+.38+.51)/(.54+.0002+.38+.51+1.69)
ccmrs_summary$coefficients[,1]
means <- tibble(means = c(4.42755569,4.42755569+-0.0323784,4.42755569+.49659050,4.42755569+0.38572185),
                labz = c("non_pd","bridge","common_pd","chromatic"))

means %>%
  mutate(labz = factor(labz, levels = c("non_pd","bridge","common_pd","chromatic"))) %>%
  ggplot(aes(y = means, x = labz)) +
  geom_bar(stat = "identity") +
  theme_minimal()-> chord_family_model_plot_1

chord_family_model_plot_1
```

## Model 2 

Building on Model 1, we then retained our chord family variable as a fixed effect, categorical predictor and modeled participant as a random intercept and years of formal musical training (question 35 from the Goldsmiths Musical Sophistication Index) as a random slope.
This allowed the model to account for the fact that ratings for chord attraction will vary as a result of how much formal, musical training an individual will recieve.

```{r}
musical_individual_model <- lmer(rating ~ chord_family  +
                                   (1+ i_have_had_formal_training_in_music_theory_for_years |participant), 
                                 data = model_data)

summary(musical_individual_model)
(1.30+0.06)/(1.30+0.06+1.81)

r.squaredGLMM(chord_category_model)
r.squaredGLMM(musical_individual_model)
anova(chord_category_model_random_slopes, musical_individual_model)

tab_model(musical_individual_model, title ="Musical Training Added")

tab_model(chord_category_model, musical_individual_model)
```

As evident from "MUSICAL TRAING ADDED TABLE", while the coeffecients associated with chord family did not appear to change with the addition of this random slope parameter, the model did fit the data significantly better ($\chi^2(7)=124.2$, $p<.001$) and our marginal $R^2$ rose from .28 to .42, suggesting that while this information did help explain more of the data, there is variation due training that can be captured beyond using participant soley as a random intercept.

```{r}
# Re-Do This with ordered Data on musical training ???
model_data %>%
  mutate(chord_family_f = factor(chord_family, levels = c("chromatic_pd","common_pd","bridge_chords","not_pd"))) %>%
  mutate(experimental_group_f = factor(experimental_group, levels = c("prolific","freshman","upperclass"))) %>%
  ggplot(aes(y = rating, x = chord_family_f, color = experimental_group_f)) +
  geom_boxplot() +
  facet_wrap(~participant) +
  coord_flip()

df %>%
  filter(participant == 31) %>%
  View()

#ggsave("img/all_participants_data.png", width = 40, height = 20, units = "cm")

```

* PLOT HERE NOTE-- DJB check after Round 1

### Model 3

Finally, we then attempted to investigate the extent that the features from TABLE X contributed to attraction ratings. 
We now include all five features from TABLE X as fixed effects predictors, preserving the rest of the model structure from the prior models.

```{r}
all_musical_indv_theory_model <- lmer(rating ~
                               chord_family +
                            lerdhal_tension + 
                            parncut_roughness + 
                            semitone_voice_move + 
                            rootmotion + 
                            number_tendency_tones4_6 + 
                            (1+ i_have_had_formal_training_in_music_theory_for_years|participant), 
                          data = model_data)

summary(all_musical_indv_theory_model)
r.squaredGLMM(all_musical_indv_theory_model)

```

Results from all three models can be seen in the table below.

```{r}
tab_model(chord_category_model,musical_individual_model, all_musical_indv_theory_model)
```

From this table, it appears that while model the model was able to continue the trend in an albeit small direction  of increasing both conditional and marginal R2 values, these increases might not lead to practical meaning or application.
What is more of interest is the unstablizing of the chord family coeffecients when the features of the model are included.
We follow up on this finding in CHORD SCALE DEGREE ANALYSIS (after discussing this analysis)

## Model Space 

```{r}
model_x <- lmer(rating ~
                            chord_family +
                            lerdhal_tension +
                            parncut_roughness +
                            semitone_voice_move +
                            rootmotion +
                            number_tendency_tones4_6 +
                            experimental_group +
                            (1 + experimental_group | participant), 
                          data = model_data)

summary(all_musical_indv_theory_model)
r.squaredGLMM(all_musical_indv_theory_model)

```

## Discussion Points


```{r}
df %>%
  group_by(participant, chord) %>%
  mutate(avg_rating = mean(rating)) %>%
  select(avg_rating) %>%
  distinct() -> avg_chord_ratings

## All features here to do this! 


df %>%
  select(participant, chord, group, chord_family, parncut_roughness:x7) %>%
  left_join(avg_chord_ratings) %>%
  mutate(group_f = factor(group, levels = c("prolific","freshman","upperclass"))) -> df2

model_y <- lmer(avg_rating ~ parncut_roughness + chord_family + (1 + chord_family|group), data = df2)
summary(model_y)

df2 %>%
  ggplot(aes(y = avg_rating, x = parncut_roughness, color = chord_family)) +
  geom_point() +
  facet_wrap(~group_f) +
  geom_smooth(method = "lm") +
  labs(title = "Interaction of Musical Training for Chromatic, Roughness")

df2 %>%
  ggplot(aes(y = avg_rating, x = semitone_voice_move, color = chord_family)) +
  geom_point() +
  facet_wrap(~group_f) +
  geom_smooth(method = "lm") +
  labs(title = "Interaction of Musical Training for Chromatic")


df2 %>%
  ggplot(aes(y = avg_rating, x = lerdhal_tension, color = chord_family)) +
  geom_point() +
  facet_wrap(~group_f) +
  geom_smooth(method = "lm")

df2 %>%
  ggplot(aes(y = avg_rating, x = number_tendency_tones4_6, color = chord_family)) +
  geom_point() +
  facet_wrap(~group_f) +
  geom_smooth(method = "lm")

```

