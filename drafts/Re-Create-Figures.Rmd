---
title: "Analysis I"
author: "David John Baker"
date: "03/06/2020"
output: html_document
editor_options: 
  chunk_output_type: console
---

This document documents the analysis used in **The attraction of predominant chords** by Brown and Tan currently under review at _Music Perception_.
The design, construction, collection of data of this experiment was done by Brown and Tan. 
Baker only assisted in data managment and analysis. 

This script re-creates both the figures, tables and anlayses used in the manuscript. 

## Data and Library Import 

Below we import in a variety of libraries from the `tidyverse` in order to analyse the data.
Data from this experiment can be found in `data/` in both the tidy format and the format used in the original submission. 
Here we also clean the variable names and join the tables to one big analysis. 

```{r}
library(readr)
library(stringr)
library(ggplot2)
library(tidyr)
library(GGally)
library(MuMIn)
library(janitor)
library(dplyr)
library(lme4)
library(lmerTest)
library(patchwork)
library(gt)

# Importing Data
## Experimental Data 
response_data <- read_csv("tidy_tables/response_data.csv")

chord_stimuli_data <- read_csv("tidy_tables/chord_experiment_stimuli_data.csv")

chord_stimuli_data <- chord_stimuli_data %>% 
  rename(chord = chord_symbol,
         chord_family = group) 

# Chord Features
chord_features <- read_csv("tidy_tables/chord_features.csv")
chord_features <- janitor::clean_names(chord_features)

chord_features <- chord_features %>%
  separate(col = stimuli, into = c("chord_id","temp"), "\\.") %>%
  separate(col = temp, into = c("chord","notes"), sep = "\\:") %>%
  mutate(chord = str_trim(chord)) %>%
  mutate(notes = str_trim(notes))

# Demographic Data
gmsi <- read_csv("tidy_tables/gmsi_table.csv")
gmsi <- janitor::clean_names(gmsi)
gmsi <- gmsi %>% 
  rename(experimental_group = group,
         participant = participant_no)

# Build Big Data 
df <- response_data %>%
  pivot_longer(cols = I:`viio7/V`,names_to = "chord",values_to = "rating") %>%
  select(participant, chord, rating, block, group, `How attracted`) %>%
  left_join(chord_stimuli_data) %>%
  left_join(gmsi) %>%
  left_join(chord_features)
```

## Manuscript Recreation 

This next section re-creates both the figures and tables used in the manuscript.
Only tables that have either response, demographic, or stimuli data are re-created. 

### Tables

* Table 3: Factors hypothesized to contribute to pre-dominant attraction for sample trials.
* Table 4: Means and standard deviations of participantsâ€™ scores on the Gold-MSI from the three
participant groups.
* Table 5: Findings from multiple regression analysis between the three participant groups and the
four hypothesized factors contributing to attraction ratings. [BELOW]
* Table 6: Mean attraction ratings from all three participant groups per trial. Each box indicates
the mean value and the 95% CI. Within each participant group column, the chords with the ten
highest attraction ratings are bolded and the chords with the ten lowest attraction ratings are
written using gray font. Remaining chords are drawn with regular black font.
* Table 7: Scale-degree pairings hypothesized to contribute to pre-dominant attraction for sample
trials.

```{r}
# Table 3
chord_features %>%
  filter(chord %in% c("I","vi","ii7","viio7/V","Gr6")) %>%
  select(chord, lerdhal_tension, parncut_roughness, semitone_voice_move, rootmotion, number_tendency_tones4_6) %>%
  gt()

# Table 4 
table_4_values <- gmsi %>%
  select(experimental_group, f1_active_engagement:fg_general_sophistication) %>%
  pivot_longer(cols = f1_active_engagement:fg_general_sophistication, 
               names_to ="gmsi_score",
               values_to = "score") %>%
  group_by(experimental_group, gmsi_score) %>%
  summarise(mean_score = mean(score),
            sd_score = sd(score)) #%>%
#  pivot_wider(names_from = gmsi_score, values_from = c(mean_score, sd_score))
table_4_values %>%
  mutate(id = paste(experimental_group, gmsi_score)) %>%
  mutate(id = str_replace_all(id, pattern = "_","\\ ")) %>%
  mutate(id = str_to_title(id)) %>%
  ggplot(aes(x = id, y = mean_score, fill = experimental_group)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = mean_score-sd_score, ymax = mean_score + sd_score)) +
  theme_minimal() +
  coord_flip() +
  labs(title = "Table 4 Summary Statistics")

#ggsave("img/table_4.png", width = 40, height = 20, units = "cm")

# Table 6 Mean Ratings Per Chord Per Group 
df %>%
  select(chord_family, chord, rating, experimental_group) %>%
  group_by(chord, experimental_group) %>%
  summarise(mean_rating = mean(rating), 
            sd_rating = sd(rating))

df %>%
  select(chord_family, chord, rating, experimental_group) %>%
  mutate(chord_family = factor(chord_family, levels = c("not_pd","bridge_chords","common_pd","chromatic_pd"))) %>%
  ggplot(aes(x = reorder(chord, rating), color = chord_family, y = rating)) +
  geom_boxplot() +
  facet_wrap(~experimental_group) +
  coord_flip() +
  labs(title = "Figure 6 Data", 
       subtitle = "Need to Decide on Ordering")

## Re-Ordered Paneling 
prolific_panel <- df %>%
  filter(experimental_group == "prolific") %>%
  select(chord_family, chord, rating, experimental_group) %>%
  mutate(chord_family = factor(chord_family, levels = c("not_pd","bridge_chords","common_pd","chromatic_pd"))) %>%
  ggplot(aes(x = reorder(chord, rating), color = chord_family, y = rating)) +
  geom_boxplot() +
  coord_flip() +
  theme_minimal() +
  labs(title = "Prolific Group Ratings") 

freshman_panel <- df %>%
  filter(experimental_group == "freshman") %>%
  select(chord_family, chord, rating, experimental_group) %>%
  mutate(chord_family = factor(chord_family, levels = c("not_pd","bridge_chords","common_pd","chromatic_pd"))) %>%
  ggplot(aes(x = reorder(chord, rating), color = chord_family, y = rating)) +
  geom_boxplot() +
  coord_flip() +
  theme_minimal() +
  labs(title = "Freshman Group Ratings") 

upperclass_panel <- df %>%
  filter(experimental_group == "upperclass") %>%
  select(chord_family, chord, rating, experimental_group) %>%
  mutate(chord_family = factor(chord_family, levels = c("not_pd","bridge_chords","common_pd","chromatic_pd"))) %>%
  ggplot(aes(x = reorder(chord, rating), color = chord_family, y = rating)) +
  geom_boxplot() +
  coord_flip() +
  theme_minimal() +
  labs(title = "Upperclass Group Ratings", xlab = "") 

prolific_panel + freshman_panel + upperclass_panel

#ggsave("img/panel_trip.png", width = 40, height = 20, units = "cm")

  
# Table 7 - tables needs reordering 
chord_features %>%
  filter(chord %in% c("I","vi","ii7","viio7/V","Gr6")) %>%
  select(chord, x4_6, x4_b6, number_4_b6, number_4_6) %>%
  distinct() 
  
```

### Figures 

* Figure 4 

```{r}

df$chord_family <- factor(df$chord_family, levels = c("not_pd","bridge_chords","common_pd","chromatic_pd"))

std <- function(x) sd(x)/sqrt(length(x))

# Figure 4
df %>%
  select(chord_family, rating, group) %>%
  group_by(chord_family) %>%
  summarise(mean_rating = mean(rating),
            sd_rating = sd(rating),
            std_rating = std(rating)) %>%
  ggplot(aes(x = chord_family, y = mean_rating)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = mean_rating - std_rating, ymax = mean_rating + std_rating)) +
  labs(title = "Figure 4",
       subtitle = "Can Add starts and make nicer") +
  theme_minimal()

ggsave("img/fig4_redo.png", width = 40, height = 20, units = "cm")

# Figure 5 A
df %>%
  select(chord_family, rating, group, experimental_group) %>%
  mutate(experimental_group = factor(experimental_group, levels = c("prolific","freshman","upperclass"))) %>%
  group_by(chord_family, experimental_group) %>%
  summarise(mean_rating = mean(rating),
            sd_rating = sd(rating),
            std_rating = std(rating)) %>%
  ggplot(aes(x = experimental_group, 
             y = mean_rating, 
             fill = chord_family)) +
  geom_bar(position = "dodge", stat = "identity") +
  geom_errorbar(
    aes(ymin = mean_rating - std_rating,
        ymax = mean_rating + std_rating),
    width = 0.2,
    position = position_dodge(width = 0.9)) + 
  coord_cartesian(ylim=c(1,7)) +
  scale_y_continuous(breaks = seq(1, 7, by = 1)) +
  labs(title = "Figure 5A",
       subtitle = "error bars are standard deviations of mean, will change to CI",
       x = "Mean Rating",
       y = "Experimental Group") +
  theme_minimal()

ggsave("img/fig_5_redo.png", width = 40, height = 20, units = "cm")

# Grouped Mean Attraction by Musical Training
# mean_ratings_participants <- df %>%
#   select(participant, rating, chord_family, block_index) %>%
#   group_by(participant, block_index) %>%
#   summarise(mean_score = mean(rating)) %>%
#   ungroup(participant)
# 
# mean_ratings_participants
# 
# mean_ratings_participants %>%
#   left_join(gmsi) %>%
#   left_join(chord_stimuli_data) %>%
#   select(participant, mean_score, chord_family, f3_musical_training) %>%
#   print(n = 100)
  

```

## Modeling

### Musical Training Subscale Questions

In this next section of the notebook, we document choices made for the regression modeling.

First, we inspect the distribution of the `I have had formal training in music theory for X years` question to see if this seven point Likert scale better captures the distribution of musical training compared to using a categorical predictor. 
We do this per suggestion of Harrell, 2019 `Regression Modeling Strategies`.

```{r}
df %>%
  select(i_have_had_formal_training_in_music_theory_for_years, group) %>%
  mutate(group = factor(group, c("prolific","freshman","upperclass"))) %>%
  ggplot(aes(x = i_have_had_formal_training_in_music_theory_for_years)) +
  geom_histogram() +
  facet_wrap(~group) +
  labs(title = "Music Theory Question Distribution by Group")

ggsave("img/theory_distribution.png", width = 40, height = 20, units = "cm")

df %>%
  select(f3_musical_training, group) %>%
  mutate(group = factor(group, c("prolific","freshman","upperclass"))) %>%
  ggplot(aes(x = f3_musical_training)) +
  geom_histogram() +
  facet_wrap(~group) +
  labs(title = "Musical Training Subscale By Group")

df %>%
  ggplot(aes(x = f3_musical_training, color = experimental_group)) +
  geom_density() +
  theme_minimal() +
  labs(title = "Using Musical Factor Clearly Picks up on Western Musical Training")

df %>%
  ggplot(aes(x = i_have_had_formal_training_in_music_theory_for_years, color = experimental_group)) +
  geom_density() +
  theme_minimal() +
  labs(title = "Theory Item of GMSI appears to best capture spread")

# And Collapsed to see pattern better 
df %>%
  ggplot(aes(x = i_have_had_formal_training_in_music_theory_for_years, color = experimental_group)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Theory Item of GMSI appears to best capture spread",
       subtitle = "Also Justifies Musical Trained in Prolific\n Better Differentiated") 

df %>%
  ggplot(aes(x = f3_musical_training, color = experimental_group)) +
  geom_boxplot() +
  theme_minimal() +
  labs(title = "Same Pattern with Musical Training",
       subtitle = "") 
```

It appears that pattern is same with GMSI and Theory Question, going to decide to use the Theory question so that it picks up on idea of specific training, not peripherial learning. 

### Hierarchical Modeling 

The dependent variable in all modeling was the `rating` variables. 
As per the design in the text, the experiment used a crossed design meaning that all participants rated all stimuli.
Stimuli were all rated twice, once in each block.

In order to first explore how much of the variation in the dependent variable was due to individual differences, we first ran a null model that consisted of of predicting variation in `rating` DV with both participant and block as random effects. 


```{r}
# Select Individual Model Data 
model_data <- df %>%
  select(rating, 
         chord_family,
         participant, 
         block, 
         i_have_had_formal_training_in_music_theory_for_years, 
         f3_musical_training,experimental_group) %>%
  mutate(experimental_group = factor(experimental_group, c("prolific", "freshman","upperclass")))
  
# Run Null Model 
null_model <- lmer(rating ~ (1|participant) + (1|block), data = model_data)
null_summary <- summary(null_model)
null_summary

print(paste(round(.47/(.47+1.87)*100,3),"% of the data is explained with null model"))
print("Variation due to block is negligable")
```

Running the null model, we were able to account for 20% of the variation in response due solely to response in the participants.
Of this 20%, a negligible amount was due to block from which we can conclude there were no effects of block.
This variable was not used for subsequent analyses. 

After the null model, we then ran a model that that listed `chord_family` as a fixed effect.
Since the manuscript theorized that there is something special about chord function/family, chord family was a fixed effect which allowed random intercepts.

```{r}
# Chord with Random Intercept 
chord_category_model <- lmer(rating ~ chord_family + (1|participant), data = model_data)
summary(chord_category_model)
# Significantly better with chord family in model
anova(null_model, chord_category_model)

# Residuals were normally distributed
hist(resid(chord_category_model))
qqnorm(resid(chord_category_model))
qqline(resid(chord_category_model)) 

r.squaredGLMM(null_model)
r.squaredGLMM(chord_category_model)
```

Results from using `chord_family` as a fixed effect resulted in a signifcantly better model fit (see Chi Squared, AIC, BIC) and improved R2 by 2%.
Results here mirror results from Figure 4 from the original manuscript.

Seeing as we hypothesized that musical training will influence rating, we then decided to add random slopes. 
Our current model forced each participant to rate all chord family data with the same pattern.

This means that we expect participants when rating chord families to exhibit the same relationship between chord family and chord rating, although we acknowledge that some populations rate chords differently.



If we were to allow chord family to have a random slope, ratings from within the chord family participant could help???

# particpiant as random effect
# gmsi as fixed effect and random slope with chord family.



```{r}
# Chord Random Slopes 
chord_category_model_random_slopes <- lmer(rating ~ chord_family + (1+ chord_family | participant), data = model_data, REML = TRUE)
(ccmrs_summary <- summary(chord_category_model_random_slopes))
(.54+.0002+.38+.51)/(.54+.0002+.38+.51+1.69)
ccmrs_summary$coefficients[,1]
means <- tibble(means = c(4.42755569,4.42755569+-0.0323784,4.42755569+.49659050,4.42755569+0.38572185),
                labz = c("non_pd","bridge","common_pd","chromatic"))

means %>%
  mutate(labz = factor(labz, levels = c("non_pd","bridge","common_pd","chromatic"))) %>%
  ggplot(aes(y = means, x = labz)) +
  geom_bar(stat = "identity") +
  theme_minimal()-> random_slopes_plot_1

df %>%
  select(chord_family, rating, group) %>%
  group_by(chord_family) %>%
  summarise(mean_rating = mean(rating),
            sd_rating = sd(rating),
            std_rating = std(rating)) %>%
  ggplot(aes(x = chord_family, y = mean_rating)) +
  geom_bar(stat = "identity") +
  geom_errorbar(aes(ymin = mean_rating - std_rating, ymax = mean_rating + std_rating)) +
  labs(title = "Figure 4") +
  theme_minimal() -> unadjusted_means_1

unadjusted_means_1 + random_slopes_plot_1

# Significantly better with chord family in model
anova(null_model, chord_category_model, chord_category_model_random_slopes)

# Again Residuals Fine
plot(chord_category_model_random_slopes)
qqnorm(resid(chord_category_model_random_slopes))
qqline(resid(chord_category_model_random_slopes)) 

```

Allowing for random slopes of chord category increased R2 to 46%.
Model fit also significantly improved.

* [ ] Make Plot Here of Slopes per group!

Check here if more interpreatlbe to put individual as random effect and let musical training level be the random slope as random effect. 


Going to add in musical training with theory as model 

```{r}
musical_individual_model <- lmer(rating ~ chord_family  + 
                                   (1+ i_have_had_formal_training_in_music_theory_for_years |participant), 
                                 data = model_data)

summary(musical_individual_model)
(1.30+0.06)/(1.30+0.06+1.81)
anova(chord_category_model_random_slopes,musical_individual_model)
```

Appears Musical Training does not help as much 

```{r}
# Re-Do This with ordered Data on musical training ???
model_data %>%
  ggplot(aes(y = rating, x = chord_family, color = experimental_group)) +
  geom_boxplot() +
  facet_wrap(~participant) +
  coord_flip()

#ggsave("img/all_participants_data.png", width = 40, height = 20, units = "cm")

```

### Musical Data

We next ran the model with just the musical data. 

```{r}

musical_model_data <- df %>%
  select(rating, chord,  chord_family, participant, 
         block, chord_id:major_minor_chromatic, experimental_group, i_have_had_formal_training_in_music_theory_for_years, f3_musical_training) %>%
  mutate(experimental_group = factor(experimental_group, c("prolific", "freshman","upperclass")))

# # Featuers are not super correlated with one another, very good! 
# musical_model_data %>%
#   select(chord_family, parncut_roughness:number_tendency_tones4_6) %>%
#   ggpairs(aes(color = chord_family))

# Run Parncut Only Model   
parncutt_only_model <- lmer(scale(rating) ~ scale(parncut_roughness) + (1+scale(parncut_roughness)|participant), data = musical_model_data)
summary(parncutt_only_model)

all_musical_model <- lmer(rating ~ 
                            lerdhal_tension + 
                            parncut_roughness + 
                            semitone_voice_move + 
                            rootmotion + 
                            number_tendency_tones4_6 + 
                            (1|participant), 
                          data = musical_model_data)

all_musical_model_summary <- summary(all_musical_model)
all_musical_model_summary

r.squaredGLMM(null_model)
r.squaredGLMM(all_musical_model)

hist(all_musical_model_summary$residuals)
qqnorm(resid(all_musical_model))
qqline(resid(all_musical_model))


all_musical_indv_theory_model <- lmer(rating ~
                               chord_family +
                            lerdhal_tension + 
                            parncut_roughness + 
                            semitone_voice_move + 
                            rootmotion + 
                            number_tendency_tones4_6 + 
                             i_have_had_formal_training_in_music_theory_for_years +
                            (1+ chord_family|participant), 
                          data = musical_model_data)

summary(all_musical_indv_theory_model)
r.squaredGLMM(all_musical_indv_theory_model)



```

Temp Garbage

```{r}


model_x <- lmer(rating ~ scale(f3_musical_training) + chord_family + (1 + chord_family | participant) +  (1 + scale(f3_musical_training) | participant), data = df )

df %>%
  select(rating, participant, chord, chord_family, f3_musical_training, participant) %>%
  group_by(participant, chord) %>%
  summarise(mean_rating = mean(rating), 
            sd_rating = sd(rating)) %>%
  ungroup() -> avg_ratings

avg_ratings %>%
  left_join(gmsi) %>%
  left_join(chord_stimuli_data) %>%
  select(mean_rating, sd_rating, chord_family, f3_musical_training ) %>%
  ggplot(aes(x = f3_musical_training, y = mean_rating, color = chord_family)) +
  geom_point() +
  theme_minimal() +
  geom_smooth(se = FALSE, method = "lm") +
  labs(title = "Single Regressions based on Chord Family")


summary(model_x)
r.squaredGLMM(model_x)

coef(model_x)

```


## Still to Do 

* [ ] Experiment with Chordal 7th vs Parncutt Model 
* [ ] Explore Other Models with Musical Features 


